<!DOCTYPE html>

<html>
	<head>
		<title>Climate Change</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>


	<body>
		<div class="container">
			<h1>Climate Change</h1>
			<div class="row">
				<div class="col-sm" id="season-container">
		      		<p>Please choose a season: </p>
					<label class="checkbox-inline"><input type="checkbox" value="Spring"> Spring</label>
					<label class="checkbox-inline"><input type="checkbox" value="Summer"> Summer</label>
					<label class="checkbox-inline"><input type="checkbox" value="Autumn"> Autumn</label>
					<label class="checkbox-inline"><input type="checkbox" value="Winter"> Winter</label>

					<p></p>
					<p>You can select a year and/or use the animation: </p>
					<input type="range" min="1800" max="2013" value="1907" class="slider" id="myRange" onchange="showYear(this.value);">
					<button type="button">Play</button>
		    	</div>
			
				<div class="col-sm" id="chart-container">
			      	<p onclick="graph()">Land Average Temperature Summer (Celsius):</p>
					<div id="chart"></div>
				</div>
			</div>
		</div>
		<div id="map" style="width:'100%'; height: 450px;"></div>
		
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/topojson.v1.min.js"></script>
		<script type="text/javascript">
			const world_json = 'http://www.alexandrepoussard.com/world.geo.json';
			const temp_major_city = 'http://www.alexandrepoussard.com/major_city_temp_season.csv';
			const temp_country = 'http://www.alexandrepoussard.com/country_temp_season.csv';
			const temp_season = 'http://www.alexandrepoussard.com/global_temp_season2.csv';
			let width = $("#map").parent().width();
	        let height = $("#map").parent().height();
	        let scale = (width - 1) / 2.2 / Math.PI;
	        let centered;

	        const projection = d3.geoEquirectangular()
	        	.scale(scale)
	        	.translate([width / 2, height / 2]);

	        const path = d3.geoPath()
    			.projection(projection);

			const color = d3.scaleLinear()
				.range(["hsl(62,100%,90%)", "hsl(228,30%,20%)"]) //"hsl(62,100%,90%)", "hsl(228,30%,20%)"
				.interpolate(d3.interpolateHsl);

			const svg = d3.select('#map').append('svg')
	        	.attr('width', width)
	        	.attr('height', height)
	        	.append("g");

	    	svg.append("rect")
			    .attr("class", "background")
			    .attr("width", width)
			    .attr("height", height);

			var g = svg.append("g");

			function showYear(val) {
          		alert(val);
        	}

        	function graph() {
				var graph_svg = d3.select("#chart").append("svg").attr("width", "500").attr("height", "150"),
				margin = {top: 20, right: 20, bottom: 30, left: 50},
				width = +graph_svg.attr("width") - margin.left - margin.right,
				height = +graph_svg.attr("height") - margin.top - margin.bottom,
				g = graph_svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			  	var parseTime = d3.timeParse("%Y");

			  	var x = d3.scaleTime()
			  		.rangeRound([0, width]);

			  	var y = d3.scaleLinear()
			  		.rangeRound([height, 0]);

			  	var line = d3.line()
			  		.x(function(d) { return x(d.date); })
			  		.y(function(d) { return y(d.close); });

			  	d3.csv(temp_season, function(d) {
			    	d.date = parseTime(d.year);
			    	d.close = +d.LandAverageTemperature;
			    	return d;
			  	}, function(error, data) {
			    	if (error) throw error;
				    data = data.filter(d => d.season == "summer")
				    console.log(data)
				    x.domain(d3.extent(data, function(d) { return d.date; }));
				    y.domain(d3.extent(data, function(d) { return d.close; }));

				    g.append("g")
				    	.attr("transform", "translate(0," + height + ")")
				    	.call(d3.axisBottom(x))
				    	.select(".domain")
				    	.remove();

				    g.append("g")
					    .call(d3.axisLeft(y))
					    .append("text")
					    .attr("fill", "#000")
					    .attr("transform", "rotate(-90)")
					    .attr("y", 6)
					    .attr("dy", "0.71em")
					    .attr("text-anchor", "end");

				    g.append("path")
					    .datum(data)
					    .attr("fill", "none")
					    .attr("stroke", "steelblue")
					    .attr("stroke-linejoin", "round")
					    .attr("stroke-linecap", "round")
					    .attr("stroke-width", 1.5)
					    .attr("d", line);
			  	});
			}

			d3.csv(temp_country, function(error, data_country) {
	    		d3.csv(temp_major_city, function(error, data_city) {
			        d3.json(world_json, function(error, json) {
						if (error) throw error;

						const countries = json;
						let dataCountryName = [];
						let dataCountryTemperature = [];
						let jsonCountryName = [];
						
						for (let i = 0; i < data_country.length; i++) {
							dataCountryName = data_country[i].Country;
							dataCountryTemperature = data_country[i].AverageTemperature;

							for (let j = 0; j < countries.features.length; j++) {
								jsonCountryName = countries.features[j].properties.sovereignt;
								if (jsonCountryName === dataCountryName) {
									countries.features[j].properties.sovereignt = dataCountryName;
									countries.features[j].properties.AverageTemperature = dataCountryTemperature;
									break;
								}
							}
						}

						var av_temperatures = data_country.map((d) => d.AverageTemperature).sort((a, b) => a - b);
						color.domain([d3.quantile(av_temperatures, .01), d3.quantile(av_temperatures, .99)]);

						g.selectAll("path")
							.data(countries.features)
							.enter()
							.append("path")
							.attr("class", "countries")
							.attr("d", path)
							.on("click", clicked)
							.style("fill", (d) => {
								const AverageTemperature = d.properties.AverageTemperature;
								return color(AverageTemperature);
							});

						g.append("path")
							.datum(topojson.mesh(json, countries, (a, b) => a !== b))
							.attr("class", "countries-boundary")
							.attr("d", path);

						g.selectAll("text")
							.data(countries.features)
							.enter().append("text")
							.attr("transform", (d) => "translate(" + path.centroid(d) + ")")
							.attr("dx", -5)
							.attr('font-size', '35%')
							.text((d) => d.properties.name);

						function clicked(d) {
							var x, y, k;

							if (d && centered !== d) {
								var centroid = path.centroid(d);
								x = centroid[0];
								y = centroid[1];
								k = 4;
								centered = d;
							} else {
								x = width / 2;
								y = height / 2;
								k = 1;
								centered = null;
							}

							g.selectAll("path")
								.classed("active", centered && function(d) { return d === centered; });

							g.transition()
								.duration(750)
								.attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
								.style("stroke-width", 0.2 / k + "px");

							// graph();
						}
					});
				});
			});
    	</script>
	</body>
</html>